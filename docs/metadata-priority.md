# Metadata Priority Flow

## Overview

This document describes how metadata priority is handled in the video downloader extension, specifically how ffprobe results take precedence over JavaScript-parsed manifest information.

## Metadata Sources

The extension has multiple sources of metadata:

1. **JavaScript-parsed Manifest Data**:
   - Extracted in the browser context from HLS/DASH manifests 
   - Provides basic information about variants, resolution, bitrate
   - May be incomplete or less accurate for some technical details

2. **FFprobe Metadata**:
   - Generated by the native host using ffprobe
   - Provides detailed technical information about video and audio streams
   - Generally more accurate for technical parameters
   - May not be available for all URLs (e.g., for blob URLs or when ffprobe fails)

## Metadata Priority System

The extension implements a clear priority system for metadata:

1. **ffprobe** (Highest Priority): Technical metadata from ffprobe is considered most accurate and takes precedence over other sources.
2. **JavaScript-parsed Manifest** (Medium Priority): Information extracted from manifests is used when ffprobe data is unavailable.
3. **Default/Existing Values** (Lowest Priority): Used as fallback when neither ffprobe nor manifest data is available.

## Implementation

The priority system is implemented through a `mergeMetadataWithPriority` function that ensures ffprobe data takes precedence, while preserving relevant manifest information when needed.

### Key Functions

- `mergeMetadataWithPriority`: Merges metadata from different sources with proper priority
- `applyMetadataToVideo`: Applies ffprobe results to a video while preserving the priority system
- `enrichWithMetadata`: Handles the process of fetching and applying ffprobe metadata

## Benefits

This approach ensures:

1. **Accuracy**: Technical parameters come from the most reliable source (ffprobe)
2. **Completeness**: Manifest data fills in gaps where ffprobe might not provide information
3. **Fallback Mechanism**: The system still functions when a particular source is unavailable
4. **Preservation of Source Data**: Original source data is preserved for debugging and reference

## Debugging

When debugging metadata issues, check:

1. `video.streamInfo`: Contains the raw ffprobe results
2. `video.mediaInfo`: Contains the consolidated metadata with proper priority applied
3. `video.manifestMetadata`: Contains the original JavaScript-parsed manifest data
